name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Send XP
        run: |
          echo "=== Starting XP Automation ==="
          echo "Time: $(date)"
          
          # Получаем токен
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          
          if [ -z "$TOKEN" ]; then
            echo "❌ ERROR: DUOLINGO_TOKEN secret is empty!"
            exit 1
          fi
          
          echo "Sending XP request..."
          
          # Используем точную конфигурацию из работающего скрипта
          RESPONSE=$(curl -s -X POST "https://api.duolingopro.net/request" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -d '{"gain_type":"xp","amount":30000}')
          
          echo "Response: $RESPONSE"
          
          # Проверяем успешность
          if echo "$RESPONSE" | grep -q '"status":true'; then
            echo "✅ Success! XP sent successfully."
          elif echo "$RESPONSE" | grep -q '"status":false'; then
            echo "❌ Failed: $(echo $RESPONSE | jq -r '.notification.body // "Unknown error"' 2>/dev/null || echo $RESPONSE)"
            
            # Проверяем конкретную ошибку #2
            if echo "$RESPONSE" | grep -q 'Invalid request format. #2'; then
              echo ""
              echo "⚠️  Error #2: Invalid request format"
              echo "Possible solutions:"
              echo "1. Token expired - get new JWT token from Duolingo cookies"
              echo "2. API changed - check if endpoint still works"
            fi
            exit 1
          else
            echo "⚠️  Unknown response format"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo ""
          echo "=== Finished at: $(date) ==="

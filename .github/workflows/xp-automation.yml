name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'  # Runs every 4 hours at minute 5 (UTC)
  workflow_dispatch:        # Allows manual triggering

permissions:
  contents: read  # Least-privilege permissions for GITHUB_TOKEN

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3  # –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å v2 –¥–æ v3

      - name: Run XP request
        run: |
          echo "‚è≥ Waiting 10 seconds..."
          sleep 10
          echo "üì§ Sending XP request..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
          if [ -z "${{ secrets.DUOLINGO_TOKEN }}" ]; then
            echo "‚ùå Error: DUOLINGO_TOKEN secret is not set"
            exit 1
          fi
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞
          RESPONSE=$(curl --ssl-no-revoke -s -w "%{http_code}" -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer ${{ secrets.DUOLINGO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 30000}')
          
          # –†–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏ –∫–æ–¥ —Å—Ç–∞—Ç—É—Å–∞
          HTTP_STATUS=${RESPONSE: -3}
          RESPONSE_BODY=${RESPONSE%???}
          
          echo "üì® HTTP Status: $HTTP_STATUS"
          echo "üì® Response from server:"
          echo "$RESPONSE_BODY"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "‚úÖ XP request successful"
          else
            echo "‚ùå XP request failed with status $HTTP_STATUS"
            exit 1
          fi

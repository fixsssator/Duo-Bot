name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'  # –ö–∞–∂–¥—ã–µ 4 —á–∞—Å–∞ –≤ 5-–π –º–∏–Ω—É—Ç–µ (UTC)
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: read

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Request XP from Duolingo PRO
        run: |
          echo "üöÄ Starting XP automation..."
          echo "‚è≥ Waiting 10 seconds before request..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is not set"
            echo "Please add your JWT token to GitHub Secrets"
            exit 1
          fi
          
          echo "üì§ Sending XP request (30,000 XP)..."
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π payload
          PAYLOAD='{
            "type": "xp",
            "amount": 30000,
            "version": "3.1BETA.03"
          }'
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π SSE (Server-Sent Events)
          echo "üîÑ Processing request (this may take a moment)..."
          
          RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: text/event-stream" \
            -d "$PAYLOAD")
          
          # –ü–∞—Ä—Å–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON –∏–∑ –ø–æ—Ç–æ–∫–∞ SSE
          LAST_LINE=$(echo "$RESPONSE" | tail -n1)
          
          if echo "$LAST_LINE" | grep -q '"status": "completed"'; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            SUCCESS_MSG=$(echo "$LAST_LINE" | sed -n 's/.*"head": "\([^"]*\)".*/\1/p')
            XP_AMOUNT=$(echo "$LAST_LINE" | sed -n 's/.*You received \([0-9]*\) XP.*/\1/p')
            
            echo "‚úÖ $SUCCESS_MSG"
            echo "üéâ Successfully received $XP_AMOUNT XP!"
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–µ
            LIMIT_INFO=$(echo "$LAST_LINE" | sed -n 's/.*"body": "\([^"]*\)".*/\1/p' | sed 's/<[^>]*>//g')
            echo "üìä $LIMIT_INFO"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            echo "‚è∞ Next request available in 4 hours"
            
          elif echo "$LAST_LINE" | grep -q '"status": "failed"'; then
            ERROR_MSG=$(echo "$LAST_LINE" | sed -n 's/.*"head": "\([^"]*\)".*/\1/p')
            echo "‚ùå Request failed: $ERROR_MSG"
            exit 1
          else
            echo "‚ö†Ô∏è  Unexpected response format:"
            echo "$LAST_LINE"
            exit 1
          fi
          
          echo "‚ú® XP automation completed successfully!"

      - name: Log completion
        run: |
          echo "üìù Logging completion..."
          echo "XP request completed at: $(date)"
          echo "Next scheduled run: 4 hours from now"

name: XP Automation

on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get install -y jq curl
        
      - name: Comprehensive API Test
        run: |
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          
          echo "=== TEST SET 1: Different Auth Headers ==="
          
          # Test 1: Bearer token (standard)
          echo "Test 1.1: Bearer token"
          curl -s -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 30000}' \
            -w " | HTTP: %{http_code}\n"
          
          # Test 2: Token without "Bearer"
          echo -e "\nTest 1.2: Token only"
          curl -s -X POST https://api.duolingopro.net/request \
            -H "Authorization: $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 30000}' \
            -w " | HTTP: %{http_code}\n"
          
          # Test 3: X-Authorization header
          echo -e "\nTest 1.3: X-Authorization"
          curl -s -X POST https://api.duolingopro.net/request \
            -H "X-Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 30000}' \
            -w " | HTTP: %{http_code}\n"
          
          echo -e "\n=== TEST SET 2: Different Payloads ==="
          
          # Test with user_id from JWT
          USER_ID=$(echo "$TOKEN" | cut -d '.' -f 2 | base64 --decode 2>/dev/null | jq -r '.sub // .user_id // "unknown"')
          
          echo "Test 2.1: With user_id ($USER_ID)"
          curl -s -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"gain_type\": \"xp\", \"amount\": 30000, \"user_id\": \"$USER_ID\"}" \
            -w " | HTTP: %{http_code}\n"
          
          echo -e "\nTest 2.2: Minimal payload"
          curl -s -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"action": "xp"}' \
            -w " | HTTP: %{http_code}\n"
          
          echo -e "\n=== TEST SET 3: Check API base ==="
          
          echo "Test 3.1: GET request to check API"
          curl -s https://api.duolingopro.net/ \
            -H "Authorization: Bearer $TOKEN" \
            -w " | HTTP: %{http_code}\n"
          
          echo -e "\nTest 3.2: Check /health or /status"
          curl -s https://api.duolingopro.net/health \
            -w " | HTTP: %{http_code}\n"
          curl -s https://api.duolingopro.net/status \
            -w " | HTTP: %{http_code}\n"

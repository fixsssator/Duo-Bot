name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Send XP
        run: |
          echo "=== Starting XP Automation ==="
          echo "Time: $(date)"
          
          # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          
          # –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is empty!"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç JWT —Ç–æ–∫–µ–Ω–∞
          JWT_PARTS=$(echo "$TOKEN" | tr '.' '\n' | wc -l)
          if [ "$JWT_PARTS" -ne 3 ]; then
            echo "‚ö†Ô∏è  Warning: Token doesn't look like standard JWT ($JWT_PARTS parts instead of 3)"
          fi
          
          # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
          echo ""
          echo "Sending XP request..."
          
          PAYLOAD='{
            "gain_type": "xp",
            "amount": 30000
          }'
          
          RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Duolingo-PRO/3.1BETA.03" \
            -d "$PAYLOAD" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "‚úÖ Success! XP sent successfully."
          else
            echo "‚ùå Failed with HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "403" ]; then
              echo ""
              echo "üîß Token likely expired. Get a fresh JWT token:"
              echo "1. Login to Duolingo in browser"
              echo "2. Open DevTools (F12)"
              echo "3. Go to Application ‚Üí Cookies"
              echo "4. Find 'jwt_token' cookie"
              echo "5. Copy its VALUE and update GitHub secret"
            fi
            
            exit 1
          fi
          
          echo ""
          echo "=== Finished at: $(date) ==="

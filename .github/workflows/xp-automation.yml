name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Test XP automation
        run: |
          echo "=== XP Automation Debug Script ==="
          echo "Script started at: $(date)"
          
          # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
          echo ""
          echo "1. Checking token..."
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is empty!"
            exit 1
          fi
          
          TOKEN_LENGTH=${#TOKEN}
          echo "   Token length: $TOKEN_LENGTH characters"
          echo "   First 20 chars: ${TOKEN:0:20}..."
          echo "   Last 20 chars: ...${TOKEN: -20}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç JWT —Ç–æ–∫–µ–Ω–∞
          echo ""
          echo "2. Validating JWT token format..."
          JWT_PARTS=$(echo "$TOKEN" | tr '.' '\n' | wc -l)
          if [ "$JWT_PARTS" -eq 3 ]; then
            echo "   ‚úÖ Token appears to be valid JWT (3 parts)"
            
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º payload –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            JWT_PAYLOAD=$(echo "$TOKEN" | cut -d'.' -f2)
            PADDING=$((4 - ${#JWT_PAYLOAD} % 4))
            if [ $PADDING -eq 4 ]; then
              PADDING=0
            fi
            for i in $(seq 1 $PADDING); do
              JWT_PAYLOAD="${JWT_PAYLOAD}="
            done
            
            echo "$JWT_PAYLOAD" | base64 -d 2>/dev/null | jq . 2>/dev/null || echo "   ‚ö†Ô∏è  Cannot decode JWT payload (might be encrypted)"
          else
            echo "   ‚ö†Ô∏è  Token doesn't look like standard JWT ($JWT_PARTS parts instead of 3)"
          fi
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ API
          echo ""
          echo "3. Testing API endpoints..."
          
          # –í–µ—Ä—Å–∏—è 1: –ö–∞–∫ –≤ –≤–∞—à–µ–º —Å–∫—Ä–∏–ø—Ç–µ
          echo ""
          echo "   Testing API v1 (as in userscript)..."
          PAYLOAD1='{
            "gain_type": "xp",
            "amount": 30000
          }'
          
          echo "   Payload: $PAYLOAD1"
          RESPONSE1=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Duolingo-PRO/3.1BETA.03" \
            -d "$PAYLOAD1" \
            -w "\n%{http_code}")
          
          HTTP_CODE1=$(echo "$RESPONSE1" | tail -n1)
          BODY1=$(echo "$RESPONSE1" | head -n -1)
          
          echo "   HTTP Code: $HTTP_CODE1"
          echo "   Response: $BODY1"
          
          # –í–µ—Ä—Å–∏—è 2: –î—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç
          echo ""
          echo "   Testing API v2 (alternative format)..."
          PAYLOAD2='{
            "type": "xp",
            "amount": 30000,
            "version": "3.1BETA.03"
          }'
          
          echo "   Payload: $PAYLOAD2"
          RESPONSE2=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD2" \
            -w "\n%{http_code}")
          
          HTTP_CODE2=$(echo "$RESPONSE2" | tail -n1)
          BODY2=$(echo "$RESPONSE2" | head -n -1)
          
          echo "   HTTP Code: $HTTP_CODE2"
          echo "   Response: $BODY2"
          
          # –í–µ—Ä—Å–∏—è 3: –¢–æ–ª—å–∫–æ XP
          echo ""
          echo "   Testing API v3 (simple xp)..."
          PAYLOAD3='{
            "type": "xp",
            "amount": 1000
          }'
          
          echo "   Payload: $PAYLOAD3"
          RESPONSE3=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD3" \
            -w "\n%{http_code}")
          
          HTTP_CODE3=$(echo "$RESPONSE3" | tail -n1)
          BODY3=$(echo "$RESPONSE3" | head -n -1)
          
          echo "   HTTP Code: $HTTP_CODE3"
          echo "   Response: $BODY3"
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏
          echo ""
          echo "4. Testing server endpoint..."
          SERVER_RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/server \
            -H "Content-Type: application/json" \
            -d '{"version": "3.1BETA.03", "key": "test"}' \
            -w "\n%{http_code}")
          
          SERVER_CODE=$(echo "$SERVER_RESPONSE" | tail -n1)
          SERVER_BODY=$(echo "$SERVER_RESPONSE" | head -n -1)
          
          echo "   HTTP Code: $SERVER_CODE"
          echo "   Server status: $(echo "$SERVER_BODY" | jq -r '.versions["3.1BETA.03"].status // "unknown"' 2>/dev/null || echo "Cannot parse")"
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          echo ""
          echo "=== Analysis ==="
          
          SUCCESS=false
          for code in "$HTTP_CODE1" "$HTTP_CODE2" "$HTTP_CODE3"; do
            if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
              SUCCESS=true
              echo "‚úÖ Found successful request with code: $code"
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "‚ùå No successful requests. Most likely issues:"
            echo "   1. Token is expired or invalid"
            echo "   2. API endpoint changed"
            echo "   3. Server is down"
            echo "   4. Rate limiting"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ 403 - –∑–∞–ø—Ä–µ—â–µ–Ω–æ
            if [[ "$HTTP_CODE1" == "403" ]] || [[ "$HTTP_CODE2" == "403" ]] || [[ "$HTTP_CODE3" == "403" ]]; then
              echo ""
              echo "‚ö†Ô∏è  Received 403 Forbidden. This usually means:"
              echo "   - Token has expired (JWT tokens expire)"
              echo "   - Token was revoked"
              echo "   - IP address is blocked"
              echo "   - User agent is blocked"
              
              echo ""
              echo "üîß Solution: Get a fresh JWT token from Duolingo:"
              echo "   1. Login to Duolingo in browser"
              echo "   2. Open DevTools (F12)"
              echo "   3. Go to Application/Storage ‚Üí Cookies"
              echo "   4. Find 'jwt_token' cookie"
              echo "   5. Copy its VALUE (not name)"
              echo "   6. Update DUOLINGO_TOKEN secret in GitHub"
            fi
            
            exit 1
          else
            echo ""
            echo "üéâ Success! XP automation is working!"
            echo "You can now reduce the debug output and keep only the working payload."
          fi
          
          echo ""
          echo "=== Script finished at: $(date) ==="

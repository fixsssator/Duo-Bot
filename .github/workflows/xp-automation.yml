name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Send XP
        run: |
          echo "=== Starting XP Automation ==="
          echo "Time: $(date)"
          
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          
          if [ -z "$TOKEN" ]; then
            echo "❌ ERROR: DUOLINGO_TOKEN secret is empty!"
            exit 1
          fi
          
          echo "Token check (first 30 chars): ${TOKEN:0:30}..."
          
          # Тестируем разные форматы запросов
          echo ""
          echo "Testing request format 1..."
          RESPONSE1=$(curl -s -X POST "https://api.duolingopro.net/request" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Duolingo-PRO/3.1BETA.03" \
            -d '{"gain_type":"xp","amount":30000}')
          
          echo "Response 1: $RESPONSE1"
          
          if echo "$RESPONSE1" | grep -q '"status":true'; then
            echo "✅ Format 1 worked!"
            exit 0
          fi
          
          echo ""
          echo "Testing request format 2..."
          RESPONSE2=$(curl -s -X POST "https://api.duolingopro.net/request" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"type":"xp","amount":30000,"version":"3.1BETA.03"}')
          
          echo "Response 2: $RESPONSE2"
          
          if echo "$RESPONSE2" | grep -q '"status":true'; then
            echo "✅ Format 2 worked!"
            exit 0
          fi
          
          echo ""
          echo "Testing request format 3..."
          RESPONSE3=$(curl -s -X POST "https://api.duolingopro.net/request" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"gain_type":"xp","amount":30000,"version":"3.1BETA.03","source":"github"}')
          
          echo "Response 3: $RESPONSE3"
          
          if echo "$RESPONSE3" | grep -q '"status":true'; then
            echo "✅ Format 3 worked!"
            exit 0
          fi
          
          # Все форматы не сработали
          echo ""
          echo "❌ All formats failed!"
          echo "Most likely token is expired."
          echo ""
          echo "To get new token:"
          echo "1. Login to Duolingo in browser"
          echo "2. Press F12 → Application tab"
          echo "3. Cookies → https://www.duolingo.com"
          echo "4. Find 'jwt_token' cookie"
          echo "5. Copy VALUE (not name)"
          echo "6. Update DUOLINGO_TOKEN in GitHub secrets"
          
          exit 1

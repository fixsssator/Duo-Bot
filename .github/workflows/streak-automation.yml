name: Streak Automation

on:
  schedule:
    - cron: '5 */4 * * *'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞ –Ω–∞ 5-–π –º–∏–Ω—É—Ç–µ (UTC)
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: read

jobs:
  streak:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq (JSON processor)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Request Streak from Duolingo PRO
        run: |
          echo "üî• Starting Streak automation..."
          echo "‚è≥ Waiting 10 seconds before request..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is not set"
            echo "Please add your JWT token to GitHub Secrets"
            exit 1
          fi
          
          echo "üì§ Sending streak request (10 streak)..."
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π payload —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞ (—è–ø–æ–Ω—Å–∫–∏–π - ja)
          PAYLOAD='{
            "type": "streak",
            "amount": 10,
            "version": "3.1BETA.03",
            "lang": "ja"
          }'
          
          echo "üîÑ Processing request (this may take a moment)..."
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π SSE (Server-Sent Events)
          RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: text/event-stream" \
            -d "$PAYLOAD")
          
          # –ü–∞—Ä—Å–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON –∏–∑ –ø–æ—Ç–æ–∫–∞ SSE
          LAST_LINE=$(echo "$RESPONSE" | tail -n1 | sed 's/^data: //')
          
          # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å –æ—Ç–≤–µ—Ç
          if [ -z "$LAST_LINE" ]; then
            LAST_LINE="$RESPONSE"
          fi
          
          echo "üìã Server response:"
          echo "$LAST_LINE" | jq '.' 2>/dev/null || echo "$LAST_LINE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
          if echo "$LAST_LINE" | grep -q '"status": "completed"'; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            HEAD=$(echo "$LAST_LINE" | sed -n 's/.*"head": "\([^"]*\)".*/\1/p')
            BODY=$(echo "$LAST_LINE" | sed -n 's/.*"body": "\([^"]*\)".*/\1/p' | sed 's/<[^>]*>//g')
            STREAK_AMOUNT=$(echo "$LAST_LINE" | sed -n 's/.*received \([0-9]*\) streak.*/\1/p')
            
            if [ -n "$HEAD" ]; then
              echo "‚úÖ $HEAD"
            else
              echo "‚úÖ Request completed successfully!"
            fi
            
            if [ -n "$STREAK_AMOUNT" ]; then
              echo "üî• Successfully received $STREAK_AMOUNT streak days!"
            else
              echo "üî• Successfully extended your streak!"
            fi
            
            # –í—ã–≤–æ–¥–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if [ -n "$BODY" ]; then
              echo "üìä $BODY"
            fi
            
          elif echo "$LAST_LINE" | grep -q '"status": false'; then
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–∏–º–∏—Ç (–∫–∞–∫ –≤ —Å–ª—É—á–∞–µ —Å Super)
            HEAD=$(echo "$LAST_LINE" | grep -o '"head": "[^"]*"' | cut -d'"' -f4)
            BODY=$(echo "$LAST_LINE" | grep -o '"body": "[^"]*"' | cut -d'"' -f4 | sed 's/<[^>]*>//g')
            
            echo "‚è≥ LIMIT REACHED: $HEAD"
            echo "üìä Details: $BODY"
            echo "‚úÖ INFO: Daily limit already used - expected behavior"
            
          elif echo "$LAST_LINE" | grep -q '"status": "failed"'; then
            ERROR_MSG=$(echo "$LAST_LINE" | sed -n 's/.*"head": "\([^"]*\)".*/\1/p')
            echo "‚ùå Request failed"
            if [ -n "$ERROR_MSG" ]; then
              echo "üìù Details: $ERROR_MSG"
            fi
            exit 1
            
          else
            # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç, –Ω–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ —Ñ–æ—Ä–º–∞—Ç
            if [ -n "$LAST_LINE" ]; then
              echo "‚ö†Ô∏è  Response received (check above for details)"
              echo "‚ÑπÔ∏è  Continuing execution..."
            else
              echo "‚ùå ERROR: No response from server"
              exit 1
            fi
          fi
          
          echo "‚ú® Streak automation completed at: $(date -u '+%H:%M:%S UTC')"

      - name: Log completion
        run: |
          echo "üìù Log entry: Streak automation ran"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

name: Super Automation

on:
  schedule:
    - cron: '0 0 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å (UTC)
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: read

jobs:
  request-super:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Request 3 Days of Super
        run: |
          echo "üöÄ Starting Super automation..."
          echo "‚è≥ Waiting 10 seconds before request..."
          sleep 10
          
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is not set"
            exit 1
          fi
          
          echo "üì§ Requesting 3 Days of Super..."
          
          RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: text/event-stream" \
            -d '{"type": "super", "amount": 1, "version": "3.1BETA.03"}')
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
          FINAL_RESPONSE=$(echo "$RESPONSE" | tail -n1 | sed 's/^data: //')
          
          echo "üìã Server response:"
          echo "$FINAL_RESPONSE" | jq '.' 2>/dev/null || echo "$FINAL_RESPONSE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
          if echo "$FINAL_RESPONSE" | grep -q '"status": "completed"'; then
            echo "‚úÖ SUCCESS: Super request processed!"
            echo "üìÖ 3 Days of Super should be added to your account"
            echo "üí° Check your Duolingo account to confirm"
            
          elif echo "$FINAL_RESPONSE" | grep -q '"status": false'; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–µ
            HEAD=$(echo "$FINAL_RESPONSE" | sed -n 's/.*"head": "\([^"]*\)".*/\1/p')
            BODY=$(echo "$FINAL_RESPONSE" | sed -n 's/.*"body": "\([^"]*\)".*/\1/p' | sed 's/<[^>]*>//g')
            MAX_AMOUNT=$(echo "$FINAL_RESPONSE" | sed -n 's/.*"max_amount": \([0-9]*\).*/\1/p')
            
            echo "‚è≥ LIMIT REACHED: $HEAD"
            echo "üìä Details: $BODY"
            
            if [ "$MAX_AMOUNT" = "0" ]; then
              echo "‚úÖ INFO: Daily limit already used"
              echo "üîÑ Next Super request will be available in ~24 hours"
              echo "‚ö†Ô∏è  This is expected behavior - nothing is broken!"
            else
              echo "üìà Max available today: $MAX_AMOUNT"
            fi
            
            # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –ª–∏–º–∏—Ç–µ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
            echo "‚ú® Automation completed (limit check)"
            
          elif echo "$FINAL_RESPONSE" | grep -q '"status": "failed"'; then
            echo "‚ùå ERROR: Request failed"
            exit 1
            
          else
            echo "‚ö†Ô∏è  UNKNOWN RESPONSE FORMAT"
            echo "$FINAL_RESPONSE"
            exit 1
          fi
          
          echo "‚è∞ Timestamp: $(date -u '+%H:%M:%S UTC')"

      - name: Log completion
        run: |
          echo "üìù Log entry: Super automation completed"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Note: If limit was reached, this is expected behavior"
          echo "Next scheduled run: Tomorrow at 00:00 UTC"

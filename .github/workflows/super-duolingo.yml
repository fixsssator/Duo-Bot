name: Super Automation

on:
  schedule:
    - cron: '0 0 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å (UTC)
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: read

jobs:
  request-super:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Request 3 Days of Super
        run: |
          echo "üöÄ Starting Super automation..."
          sleep 5
          
          TOKEN="${{ secrets.DUOLINGO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå ERROR: DUOLINGO_TOKEN secret is not set"
            exit 1
          fi
          
          echo "üì§ Requesting 3 Days of Super..."
          
          RESPONSE=$(curl --silent --ssl-no-revoke -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: text/event-stream" \
            -d '{"type": "super", "amount": 1, "version": "3.1BETA.03"}')
          
          # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –æ—Ç–≤–µ—Ç–∞
          LAST_LINE=$(echo "$RESPONSE" | tail -n1 | sed 's/^data: //')
          
          echo "üìã Server response received"
          echo "$LAST_LINE" | jq '.' 2>/dev/null || echo "$LAST_LINE"
          
          # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ –µ—Å—Ç—å response, —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
          if [ -n "$LAST_LINE" ]; then
            if echo "$LAST_LINE" | grep -q '"status": "completed"'; then
              echo "üéâ SUCCESS: 3 Days of Super added!"
            elif echo "$LAST_LINE" | grep -q '"status": false'; then
              echo "‚è≥ INFO: Daily limit reached (normal - try again tomorrow)"
            else
              echo "‚ö†Ô∏è  Response received (check above for details)"
            fi
            echo "‚úÖ Automation completed"
          else
            echo "‚ùå ERROR: No response from server"
            exit 1
          fi
          
          echo "‚è∞ Next run: $(date -u -d 'tomorrow 00:00' '+%Y-%m-%d %H:%M UTC')"

      - name: Log completion
        run: |
          echo "üìù Super automation ran at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
